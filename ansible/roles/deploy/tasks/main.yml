---
- name: Install git
  ansible.builtin.apt:
    name: git
    state: present

- name: Clone repository
  ansible.builtin.git:
    repo: "{{ repo_url }}"
    dest: "{{ deploy_path }}"
    version: "{{ repo_branch }}"
    force: true
    depth: 1
    single_branch: true

- name: Create acme.json with correct permissions
  ansible.builtin.file:
    path: "{{ deploy_path }}/stacks/acme.json"
    state: touch
    mode: "0600"

- name: Setup acme.json backup cron
  ansible.builtin.cron:
    name: "Backup acme.json"
    minute: "0"
    hour: "3"
    job: "cp {{ deploy_path }}/stacks/acme.json {{ deploy_path }}/stacks/acme.json.backup"

- name: Deploy Docker Compose stack
  community.docker.docker_compose_v2:
    project_src: "{{ deploy_path }}/stacks"
    state: present
    pull: always
    recreate: always
  environment:
    ACME_EMAIL: "{{ lookup('env', 'ACME_EMAIL') }}"
    TRAEFIK_DASHBOARD_HOST: "traefik.{{ domain }}"
    TRAEFIK_DASHBOARD_AUTH: "{{ lookup('env', 'TRAEFIK_DASHBOARD_AUTH') }}"
    WHOAMI_HOST: "whoami.{{ domain }}"
    POSTGRES_USER: app
    POSTGRES_PASSWORD: "{{ lookup('env', 'POSTGRES_PASSWORD') }}"
    POSTGRES_DB: app
    MYAPP_HOST: "app.{{ domain }}"
    MYAPP_IMAGE: nginx:alpine
